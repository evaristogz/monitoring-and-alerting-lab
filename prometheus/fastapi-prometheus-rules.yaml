apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: fastapi-alert-rules
  namespace: monitoring
  labels:
    release: prometheus
    role: alert-rules
spec:
  groups:
  - name: fastapi_alerts
    rules:
    - alert: HighRequestRate
      expr: rate(server_requests_total[1m]) * 60 > 5
      for: 30s
      labels:
        severity: high
        service: fastapi-server
      annotations:
        summary: "High request rate detected on FastAPI"
        description: "The FastAPI app is receiving more than 5 requests per minute (current rate: {{ $value }} req/min)"
    
    - alert: FastAPIApplicationDown
      expr: up{job="fastapi-server"} == 0
      for: 30s
      labels:
        severity: critical
        service: fastapi-server
      annotations:
        summary: "FastAPI Application is down"
        description: "The FastAPI application is not responding to health checks"
    
    - alert: VeryHighRequestRate
      expr: rate(server_requests_total[1m]) * 60 > 10
      for: 15s
      labels:
        severity: critical
        service: fastapi-server
      annotations:
        summary: "Very high request rate on FastAPI"
        description: "FastAPI is experiencing very high request rates ({{ $value }} req/min)"
    
    - alert: ExtremeRequestRate
      expr: rate(server_requests_total[1m]) * 60 > 50
      for: 10s
      labels:
        severity: critical
        service: fastapi-server
      annotations:
        summary: "EXTREME request rate detected on FastAPI"
        description: "FastAPI is under heavy load with {{ $value }} requests per minute. This may indicate a DDoS attack or system overload."
    
    - alert: FastAPIHighConcurrency
      expr: sum(up{job="fastapi-server"}) > 1
      for: 30s
      labels:
        severity: high
        service: fastapi-server
      annotations:
        summary: "Multiple FastAPI instances detected"
        description: "FastAPI has {{ $value }} active instances, which may indicate high load or scaling events."