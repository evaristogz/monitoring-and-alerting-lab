# Default values for fast-api-webapp.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

replicaCount: 1
image:
  repository: evaristogz/fastapi-server
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: "0.0.3"
# imagePullSecrets created to use Docker Hub Private Account
imagePullSecrets:
  - name: dockerhub-access
# -- imageCredentials for DockerHub private account
imageCredentials:
  ## -- DockerHub registry URL
  registry: "https://index.docker.io/v2/"
  ## -- DockerHub account's username
  username: ""
  ## -- DockerHub account's token (only read permissions)
  password: ""
serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""
podAnnotations: {}
podSecurityContext: {}
# fsGroup: 2000

securityContext: {}
# capabilities:
#   drop:
#   - ALL
# readOnlyRootFilesystem: true
# runAsNonRoot: true
# runAsUser: 1000

## -- Metrics configuration of the application to deploy
metrics:
  # -- Indicates whether this app will expose metrics
  enabled: true
  # -- Service configuration used for metrics
  svc:
    # -- Service port number used for metrics
    port: 8000
    # -- Service port name used for metrics
    name: metrics
# -- Service configuration
service:
  # -- Service Type
  type: ClusterIP
  # -- Service number for the webapp
  port: 8081
ingress:
  enabled: false
  className: ""
  annotations: {}
  # kubernetes.io/ingress.class: nginx
  # kubernetes.io/tls-acme: "true"
  hosts:
    - host: chart-example.local
      paths:
        - path: /
          pathType: ImplementationSpecific
  tls: []
  #  - secretName: chart-example-tls
  #    hosts:
  #      - chart-example.local
# -- Resources configuration for the deployment
resources:
  limits:
    cpu: 200m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi
autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 100
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 70
nodeSelector: {}
tolerations: []
affinity: {}
config:
  mongoService: mongodb
mongodb:
  # -- Indicate whether MongoDB will be enabled or not
  enabled: false
  # -- Number of members of MongoDB replicaset
  members: 3
  # -- MongoDB version
  version: "5.0.6"
  # -- MongoDB Admin User
  adminUser: "my-user"
  # -- MongoDB user
  user: "my-user-fast-api"
  # -- MongoDB password
  password: "password"
  # -- Metrics configuration
  metrics:
    # -- Indicate wheter the metrics will be configured or not
    enabled: true

# -- Grafana Dashboard Configuration
grafana:
  # -- Dashboard configuration
  dashboard:
    # -- Enable dashboard creation
    enabled: true
    # -- Grafana namespace where the ConfigMap will be created
    namespace: "monitoring"
    # -- Dashboard JSON content
    json: |
      {
        "annotations": {
          "list": []
        },
        "editable": true,
        "fiscalYearStartMonth": 0,
        "graphTooltip": 0,
        "id": null,
        "links": [],
        "liveNow": false,
        "panels": [
          {
            "datasource": {
              "type": "prometheus",
              "uid": "prometheus"
            },
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "thresholds"
                },
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    },
                    {
                      "color": "yellow",
                      "value": 100
                    },
                    {
                      "color": "red",
                      "value": 1000
                    }
                  ]
                },
                "unit": "short"
              },
              "overrides": []
            },
            "gridPos": {
              "h": 8,
              "w": 6,
              "x": 0,
              "y": 0
            },
            "id": 1,
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "values": false,
                "calcs": [
                  "lastNotNull"
                ],
                "fields": ""
              },
              "textMode": "auto"
            },
            "pluginVersion": "9.0.0",
            "targets": [
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "prometheus"
                },
                "expr": "server_requests_total",
                "refId": "A"
              }
            ],
            "title": "Total Server Requests",
            "type": "stat"
          },
          {
            "datasource": {
              "type": "prometheus", 
              "uid": "prometheus"
            },
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "thresholds"
                },
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    },
                    {
                      "color": "yellow", 
                      "value": 1
                    },
                    {
                      "color": "red",
                      "value": 3
                    }
                  ]
                },
                "unit": "short"
              },
              "overrides": []
            },
            "gridPos": {
              "h": 8,
              "w": 6,
              "x": 6,
              "y": 0
            },
            "id": 2,
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "values": false,
                "calcs": [
                  "lastNotNull"
                ],
                "fields": ""
              },
              "textMode": "auto"
            },
            "pluginVersion": "9.0.0",
            "targets": [
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "prometheus"
                },
                "expr": "changes(process_start_time_seconds[1h])",
                "refId": "A"
              }
            ],
            "title": "Application Restarts (Last Hour)",
            "type": "stat"
          },
          {
            "datasource": {
              "type": "prometheus",
              "uid": "prometheus"
            },
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "palette-classic"
                },
                "custom": {
                  "axisLabel": "",
                  "axisPlacement": "auto",
                  "barAlignment": 0,
                  "drawStyle": "line",
                  "fillOpacity": 0,
                  "gradientMode": "none",
                  "hideFrom": {
                    "legend": false,
                    "tooltip": false,
                    "vis": false
                  },
                  "lineInterpolation": "linear",
                  "lineWidth": 1,
                  "pointSize": 5,
                  "scaleDistribution": {
                    "type": "linear"
                  },
                  "showPoints": "auto",
                  "spanNulls": false,
                  "stacking": {
                    "group": "A",
                    "mode": "none"
                  },
                  "thresholdsStyle": {
                    "mode": "off"
                  }
                },
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    },
                    {
                      "color": "red",
                      "value": 80
                    }
                  ]
                }
              },
              "overrides": []
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 0
            },
            "id": 3,
            "options": {
              "legend": {
                "calcs": [],
                "displayMode": "list",
                "placement": "bottom"
              },
              "tooltip": {
                "mode": "single",
                "sort": "none"
              }
            },
            "targets": [
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "prometheus"
                },
                "expr": "main_requests_total",
                "legendFormat": "Main Endpoint (/)",
                "refId": "A"
              },
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "prometheus"
                },
                "expr": "healthcheck_requests_total",
                "legendFormat": "Health Check (/health)",
                "refId": "B"
              },
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "prometheus"
                },
                "expr": "bye_requests_total",
                "legendFormat": "Bye Endpoint (/bye)",
                "refId": "C"
              }
            ],
            "title": "Requests per Endpoint",
            "type": "timeseries"
          }
        ],
        "refresh": "5s",
        "schemaVersion": 36,
        "style": "dark",
        "tags": [
          "fastapi",
          "monitoring"
        ],
        "templating": {
          "list": []
        },
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "timepicker": {},
        "timezone": "",
        "title": "FastAPI Monitoring Dashboard",
        "uid": "fastapi-server",
        "version": 0,
        "weekStart": ""
      }
